version: '3.8'

services:
  paperstream:
    build: .
    container_name: paperstream
    ports:
      - "8089:8089"
    volumes:
      # Mount models directory - persists downloaded BioBERT/BiomedCLIP models
      # This SIGNIFICANTLY speeds up container restarts (no re-download)
      - ./src/paperstream/models:/app/src/paperstream/models
      
      # Mount data directory - persists database, papers, images
      - ./data:/app/data
    environment:
      - PAPERSTREAM_HOST=0.0.0.0
      - PAPERSTREAM_PORT=8089
      - SD_API_URL=http://host.docker.internal:7860
      - PYTHONUNBUFFERED=1
    extra_hosts:
      # Allow container to access host services (e.g., Stable Diffusion)
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8089/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# Usage:
# Build and start:   docker-compose up -d --build
# View logs:         docker-compose logs -f
# Stop:              docker-compose down
# Rebuild:           docker-compose up -d --build --force-recreate
